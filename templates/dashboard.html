<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PassManager Secured</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body>
    <div class="container">
        <div class="header-actions">
            <div>
                <h2>Kho Mật Khẩu</h2>
                <p style="color: var(--text-muted); margin: 0;">Quản lý tài khoản an toàn của bạn</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <a href="/add" class="btn btn-primary">
                    <i class="ph-plus-bold"></i> Thêm mới
                </a>
                <a href="/logout" class="btn btn-outline">
                    <i class="ph-sign-out"></i> Đăng xuất
                </a>
            </div>
        </div>

        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="alert alert-success">
                <i class="ph-check-circle-bold"></i>
                {% for message in messages %}{{ message }}{% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <div class="dashboard-card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="padding-left: 30px;">Dịch vụ / Ứng dụng</th>
                            <th>Tên đăng nhập</th>
                            <th>Ngày tạo</th>
                            <th style="text-align: right; padding-right: 30px;">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if entries|length == 0 %}
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <i class="ph-folder-open-thin" style="font-size: 48px; margin-bottom: 10px; display: block;"></i>
                                Chưa có mật khẩu nào được lưu. Hãy thêm mới!
                            </td>
                        </tr>
                        {% else %}
                            {% for entry in entries %}
                            <tr>
                                <td style="padding-left: 30px;">
                                    <strong>{{ entry.service_name }}</strong>
                                </td>
                                <td>
                                    <span style="font-family: monospace; background: #f1f5f9; padding: 4px 8px; border-radius: 4px;">{{ entry.username }}</span>
                                </td>
                                <td style="color: var(--text-muted); font-size: 0.9rem;">
                                    {{ entry.created_at[:10] }}
                                </td>
                                <td>
                                    <div class="actions-cell" style="justify-content: flex-end; padding-right: 15px;">
                                        <button onclick="viewPass('{{ entry.id }}')" class="btn btn-outline btn-sm" title="Xem & Copy Mật khẩu">
                                            <i class="ph-eye-bold"></i> Xem
                                        </button>
                                        <a href="/delete/{{ entry.id }}" class="btn btn-danger" onclick="return confirm('Bạn có chắc muốn xóa mật khẩu này không? Hành động này không thể hoàn tác.')" title="Xóa mục này">
                                            <i class="ph-trash-bold"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close" onclick="closeModal()">×</button>
            <i class="ph-shield-check-fill" style="font-size: 40px; color: var(--accent-color); margin-bottom: 10px;"></i>
            <h3>Mật khẩu đã giải mã</h3>
            <p style="color: var(--text-muted);">Đây là mật khẩu của bạn. Hãy cẩn thận khi chia sẻ.</p>
            
            <div class="pwd-display-box">
                <span id="pwd-text">Fetching...</span>
                <button class="btn btn-sm btn-outline" onclick="copyToClipboard()" title="Copy">
                    <i class="ph-copy-bold"></i>
                </button>
            </div>
            <button onclick="closeModal()" class="btn btn-primary btn-sm" style="width: auto; padding-left: 30px; padding-right: 30px;">Đóng lại</button>
        </div>
    </div>

    <script>
        const modal = document.getElementById('passwordModal');
        const pwdText = document.getElementById('pwd-text');

        function closeModal() {
            modal.style.display = 'none';
            pwdText.innerText = ''; // Xóa text khi đóng để bảo mật
        }

        async function viewPass(entryId) {
            modal.style.display = 'flex'; // Hiện modal
            pwdText.innerText = "Đang giải mã...";
            try {
                const response = await fetch(`/view/${entryId}`);
                if (response.status === 401) {
                    alert("Phiên làm việc hết hạn, vui lòng đăng nhập lại.");
                    window.location.href = "/login";
                    return;
                }
                const data = await response.json();
                if (data.password) {
                    pwdText.innerText = data.password;
                } else {
                    pwdText.innerText = "Lỗi: Không thể giải mã!";
                }
            } catch (e) {
                pwdText.innerText = "Lỗi kết nối server!";
            }
        }

        function copyToClipboard() {
             const text = pwdText.innerText;
             if(text && text !== "Đang giải mã..." && !text.startsWith("Lỗi")) {
                 navigator.clipboard.writeText(text).then(() => {
                     alert("Đã copy mật khẩu vào bộ nhớ tạm!");
                 });
             }
        }
        
        // Đóng modal khi click ra ngoài
        modal.addEventListener('click', function(e) {
            if (e.target === modal) closeModal();
        });
    </script>
</body>
</html>